function getQueryVariable(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(decodeURIComponent(e[0])==a)return decodeURIComponent(e[1])}console.log("Query variable %s not found",a)}function launchIntoFullscreen(a){a.requestFullscreen?a.requestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.msRequestFullscreen&&a.msRequestFullscreen()}function runTease(a,b){return __awaiter(this,void 0,void 0,function*(){Settings.set("teaseId",a),$("#exit").click(()=>{rating.show()}),rating=new Rating($("#rating"));var c=new FlashTease(a,$("#tease"));if(yield c.parse(),$("#loading").hide(),1==b){var d=c.loadState(!1);d==StateLoadResult.VersionMismatch&&(console.log("Version mismatch with saved data"),confirm("The tease was updated since your last visit.\nContinuing may result in strange behavior. Do you really want to load your saved state?")&&(d=c.loadState(!0))),d!=StateLoadResult.Ok&&(console.log("Failed to load state."),c.start())}else c.start()})}var rating,__awaiter=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})};class Control{constructor(){this.children=Array(),this._x=0,this._y=0,this._width=0,this._height=0,this.node=$("<div></div>"),this.node.attr("flashclass",this.constructor.name)}get x(){return this._x}set x(a){this._x=a,this.updateNode()}get y(){return this._y}set y(a){this._y=a,this.updateNode()}get width(){return this._width}set width(a){this._width=a,this.updateNode()}get height(){return this._height}set height(a){this._height=a,this.updateNode()}get parent(){return this._parent}set parent(a){this._parent=a}updateNode(){this.node.css("box-sizing","content-box"),this.node.width(this.width),this.node.height(this.height),this.node.css("left",this.x),this.node.css("top",this.y),this.node.css("position","absolute"),this.node.css("box-sizing","")}render(a){for(var b in this.children)this.children[b].render(this.node);a.append(this.node)}addChild(a){this.children.push(a),a.parent=this}removeChild(a){a.parent=null,a.destroy(),delete this.children[this.children.indexOf(a)]}destroy(){for(var a in this.children)this.children[a].destroy();this.node.remove()}}var StateLoadResult;!function(a){a[a.Ok=0]="Ok",a[a.NoData=1]="NoData",a[a.VersionMismatch=2]="VersionMismatch"}(StateLoadResult||(StateLoadResult={}));class FlashTease extends Control{constructor(a,b){super(),$(window).resize(a=>{this.width=b.width(),this.height=b.height(),this._currentClip.setBounds(this.bounds)}),this._id=a,this._renderTarget=b,this._actionRegistry=new Array,this.width=b.width(),this.height=b.height()}saveState(){window.localStorage.setItem(`tease-${this._id}`,Pcm2Compat.serialize(this._scriptHash))}loadState(a){var b=window.localStorage.getItem(`tease-${this._id}`);if(!b||""==b)return StateLoadResult.NoData;var c=Pcm2Compat.deserialize(this._scriptHash,b,a);return c==StateLoadResult.Ok&&this.runAction(Pcm2Compat.getCurrentAction().toString(),!1),c}load(){return new Promise((a,b)=>jQuery.get("script?id="+this._id,(b,c,d)=>{console.log("downloaded script successfully"),this._scriptHash=SparkMD5.hash(b),this._script=b,a()}))}loadMeta(){return new Promise((a,b)=>jQuery.get("meta?id="+this._id,b=>{console.log("downloaded metadata successfully"),MediaLoader.interpretMetainfo(b),MediaLoader.cacheAction(new ActionString("start")),a()}))}parse(){return __awaiter(this,void 0,void 0,function*(){this._script||(yield this.load(),yield this.loadMeta());var a=Parser.explode("\n",this._script);for(var b in a){var c=a[b];if(0!=c.length){var d=c.indexOf("#");if(d==-1||d>c.indexOf("("))this.runCommandAsAction(new CommandString(c));else{var e=c.substr(0,d),f=c.substr(d+1);this.addAction(e,f)}}}})}start(){this.runAction("start")}runAction(a,b=!0){var c=null,d=null,e=null,f=NaN;if(a instanceof ActionString&&(a=a.toString()),a instanceof CommandString&&(a=a.toString()),d=this.resolveAction(a),console.log("Running action "+d+"..."),"exittease"==d.toString())return window.localStorage.removeItem(`tease-${this._id}`),void rating.show();if(void 0!=this._actionRegistry[d.toString()]){if(c=this._actionRegistry[d.toString()],b&&Pcm2Compat.noteActionRun(d),MediaLoader.cacheAction(d),"{"==c.substr(0,1)){for(e=Parser.explodeWithParenthesis(";",c.substr(1)),c="mult(",f=0;e.length;)c=c+"e"+f+":"+e.shift(),f++,e.length&&(c+=",");c+=")"}var g=Parser.parseParameter(c);return g instanceof CommandString||console.error(this,"Action "+d+" does not contain a valid command."),void this.runCommandAsAction(g)}console.error(this,"Action not found: "+d)}isValidAction(a){return void 0!=this._actionRegistry[a]}runCommandAsAction(a){this.clearCurrentClip(),this._currentClip=a.getCmdObject(),this._currentClip.setViewer(this);var b=a.getInputVars();this.addChild(this._currentClip),this._currentClip.initialize(b,this.bounds),this.render(this._renderTarget),this.saveState()}clearCurrentClip(){null!=this._currentClip&&(this._currentClip.destroy(),this._currentClip.parent==this&&this.removeChild(this._currentClip))}resolveAction(a){var b=null,c=null;return")"==a.substr(-1)?(c=new CommandString(a).loadCmdClip(this),b=c.getAction()):b=new ActionString(a),b}addAction(a,b){this._actionRegistry[a]=b}get bounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}class CommandString{constructor(a){this._action=a}getCmdObject(){var a=this._action.indexOf("("),b=this._action.substr(0,a);return Library.getCommandClass(b)}loadCmdClip(a,b=null){var c=this.getCmdObject(),d=this.getInputVars();return c.setViewer(a),null==b&&(b={x:0,y:0,width:0,height:0}),c.initialize(d,b),c}getInputVars(){var a=this._action.indexOf("("),b=this._action.substr(a+1,this._action.length-a-2);return Parser.parseParamList(b)}toString(){return this._action}}class Library{static getCommandClass(a){switch(a){case"buttons":return new Buttons;case"page":return new Page;case"text":return new TextView;case"pic":return new Pic;case"mult":return new Mult;case"yn":return new Yn;case"set":return new SetCommand;case"unset":return new UnsetCommand;case"delay":return new Delay;case"go":return new Go;case"range":return new RangeCommand;case"dummy":return new Dummy;case"goto":return new Goto;case"horiz":return new Horiz;case"vert":return new Vert;case"must":return new Must;case"mustnot":return new MustNot;case"numactions":return new NumActions;case"numactionsfrom":return new NumActionsFrom;case"random":return new RandomCommand;case"repeat":return new Repeat;case"repeatadd":return new RepeatAdd;case"repeatdel":return new RepeatDel;case"repeatset":return new RepeatSet;case"sound":return new SoundCommand}return console.log("Invalid command: "+a),new Dummy}}class ActionString{constructor(a){this.toString=(()=>{return this._string}),this._string=a}}class Settings{static get(a,b=null){return void 0==Settings._settings[a]?b:Settings._settings[a]}static set(a,b){Settings._settings[a]=b}}Settings._settings=Array();class MediaImage{constructor(a){this.url=a}}class Sound{constructor(a){this.url=a}}class MediaLoader{static showImage(a,b=null){if(null!=MediaLoader._loadedImages[a]){console.log("Image "+a+" from cache...");var c=MediaLoader._loadedImages[a];return a.indexOf("*")>-1&&delete MediaLoader._loadedImages[a],c}return console.log("Downloading image "+a+" ..."),a="medialocation?folder="+Settings.get("mediaFolder")+"&id="+a,$.get(a,c=>{MediaLoader._loadedImages[a]=new MediaImage(c),b(c)}),null}static getSound(a,b=null){if(null!=MediaLoader._loadedSounds[a]){console.log("Sound "+a+" from cache...");var c=MediaLoader._loadedSounds[a];return a.indexOf("*")>-1&&delete MediaLoader._loadedSounds[a],c}console.log("Downloading sound "+a+" ..."),a="medialocation?folder="+Settings.get("mediaFolder")+"&id="+a,$.get(a,c=>{MediaLoader._loadedSounds[a]=new Sound(c),b(c)})}static emptyQueue(){MediaLoader._queue=[]}static queueMedia(a){MediaLoader._queue.push(a)}static runQueue(){MediaLoader._queueRunning||(MediaLoader._queueRunning=!0,MediaLoader.loadNextQueueItem())}static loadNextQueueItem(a=null){if(window.clearInterval(MediaLoader._queueIdleTimer),0==MediaLoader._queue.length)return void(MediaLoader._queueIdleTimer=window.setInterval(MediaLoader.loadNextQueueItem,1e3));var b=MediaLoader._queue.shift();"pic:"==b.substr(0,4)?MediaLoader.loadImage(b.substr(4)):"sound:"==b.substr(0,6)?MediaLoader.loadSound(b.substr(6)):MediaLoader.loadNextQueueItem()}static loadSound(a){if(null!=MediaLoader._loadedSounds[a])return void MediaLoader.loadNextQueueItem();var b="medialocation?folder="+Settings.get("mediaFolder")+"&id="+a;console.log("Preloading "+b+"..."),$.get(b,b=>{var c=document.createElement("audio");c.autoplay=!1,c.preload="auto",c.addEventListener("loadeddata",function(c){MediaLoader._loadedSounds[a]=new Sound(b),MediaLoader._loadedSounds[a].audio=c.target,MediaLoader.loadNextQueueItem()}),c.src=b})}static loadImage(a){if(null!=MediaLoader._loadedImages[a])return void MediaLoader.loadNextQueueItem();var b="medialocation?folder="+Settings.get("mediaFolder")+"&id="+a;console.log("Preloading "+b+"..."),$.get(b,b=>{var c=document.createElement("img");c.addEventListener("load",function(c){var d=c.target;MediaLoader._loadedImages[a]=new MediaImage(b),MediaLoader._loadedImages[a].width=d.width,MediaLoader._loadedImages[a].height=d.height,MediaLoader.loadNextQueueItem()}),c.src=b})}static cacheAction(a){MediaLoader.emptyQueue(),MediaLoader.queueActionMedia(a);for(var b in MediaLoader._execTree[a.toString()])MediaLoader.queueActionMedia(MediaLoader._execTree[a.toString()][b]);MediaLoader.runQueue()}static queueActionMedia(a){for(var b in MediaLoader._mediaList[a.toString()])MediaLoader.queueMedia(MediaLoader._mediaList[a.toString()][b])}static interpretMetainfo(a){var b=null,c=NaN,d=null,e=null,f=null;console.log("MetaInfo loaded.");var g=a.split("\n"),h=g[0];g[1],g[2];Settings.set("mediaFolder",h+"/"+Settings.get("teaseId")),g=g.slice(3);var i=1;for(b in g)if("=============================="==g[b])i=2;else if(i>0){c=g[b].indexOf("#"),d=new ActionString(g[b].substr(0,c)),e=g[b].substr(c+1).split(",");for(f in e)1==i?MediaLoader.addMediaInstance(d,e[f]):MediaLoader.addExecRelation(d,new ActionString(e[f]))}}static addExecRelation(a,b){null==MediaLoader._execTree[a.toString()]&&(MediaLoader._execTree[a.toString()]=new Array),MediaLoader._execTree[a.toString()].push(b)}static addMediaInstance(a,b){null==MediaLoader._mediaList[a.toString()]&&(MediaLoader._mediaList[a.toString()]=new Array),MediaLoader._mediaList[a.toString()].push(b)}}MediaLoader._mediaList=new Array,MediaLoader._execTree=new Array,MediaLoader._queue=new Array,MediaLoader._queueRunning=!1,MediaLoader._loadedImages=new Array,MediaLoader._loadedSounds=new Array;class Pcm2Compat{static serialize(a){var b={version:1,hash:a,actionSet:Pcm2Compat._actionSet,currentAction:Pcm2Compat._currentAction.toString(),actionRunCounter:Pcm2Compat._actionRunCounter,actionFirstRun:Pcm2Compat._actionFirstRun,actionLastRun:Pcm2Compat._actionLastRun,actionRepeat:Pcm2Compat._actionRepeat,actionNumActions:Pcm2Compat._actionNumActions,actionMustNot:Pcm2Compat._actionMustNot,actionMust:Pcm2Compat._actionMust,actionNumActionsFrom:Pcm2Compat._actionNumActionsFrom};return JSON.stringify(b)}static deserialize(a,b,c){var d=JSON.parse(b);return null==d?StateLoadResult.NoData:c||d.hash==a?(Pcm2Compat._actionSet=d.actionSet,Pcm2Compat._currentAction=new ActionString(d.currentAction),Pcm2Compat._actionRunCounter=d.actionRunCounter,Pcm2Compat._actionFirstRun=d.actionFirstRun,Pcm2Compat._actionLastRun=d.actionLastRun,Pcm2Compat._actionRepeat=d.actionRepeat,Pcm2Compat._actionNumActions=d.actionNumActions,Pcm2Compat._actionMustNot=d.actionMustNot,Pcm2Compat._actionMust=d.actionMust,Pcm2Compat._actionNumActionsFrom=d.actionNumActionsFrom,StateLoadResult.Ok):StateLoadResult.VersionMismatch}static setAction(a){void 0==Pcm2Compat._actionSet[a.toString()]&&(Pcm2Compat._actionSet[a.toString()]=0),Pcm2Compat._actionSet[a.toString()]=Pcm2Compat._actionSet[a.toString()]+1}static unsetAction(a){Pcm2Compat._actionSet[a.toString()]=0}static noteActionRun(a){Pcm2Compat._currentAction=a,Pcm2Compat._actionRunCounter++,Pcm2Compat.setAction(a),void 0==Pcm2Compat._actionFirstRun[a.toString()]&&(Pcm2Compat._actionFirstRun[a.toString()]=Pcm2Compat._actionRunCounter),Pcm2Compat._actionLastRun[a.toString()]=Pcm2Compat._actionRunCounter}static checkRelations(a){var b=null,c=NaN;if(Pcm2Compat.isSetAction(a))return console.log(a+" relation unfulfilled: action is set"),!1;for(b in Pcm2Compat._actionMust[a.toString()])if(!Pcm2Compat.isSetAction(Pcm2Compat._actionMust[a.toString()][b]))return console.log(a+" relation unfulfilled: must "+Pcm2Compat._actionMust[a.toString()][b]),!1;for(b in Pcm2Compat._actionMustNot[a.toString()])if(Pcm2Compat.isSetAction(Pcm2Compat._actionMustNot[a.toString()][b]))return console.log(a+" relation unfulfilled: mustnot "+Pcm2Compat._actionMustNot[a.toString()][b]),!1;if(void 0!=Pcm2Compat._actionNumActions[a.toString()]&&Pcm2Compat._actionRunCounter<Pcm2Compat._actionNumActions[a.toString()])return console.log(a+" relation unfulfilled: numactions > "+Pcm2Compat._actionNumActions[a.toString()]+" (but is "+Pcm2Compat._actionRunCounter+")"),!1;for(b in Pcm2Compat._actionNumActionsFrom[a.toString()])if((c=Pcm2Compat._actionRunCounter-Pcm2Compat._actionFirstRun[Pcm2Compat._actionNumActionsFrom[a.toString()][b].since])<Pcm2Compat._actionNumActionsFrom[a.toString()][b].num)return console.log(a+" relation unfulfilled: numactionsfrom "+Pcm2Compat._actionNumActionsFrom[a.toString()][b].since+" > "+Pcm2Compat._actionNumActionsFrom[a.toString()][b].num+" (but is "+c+")"),!1;return console.log(a+" all relations fulfilled"),!0}static addMustNotRelation(a,b){void 0==Pcm2Compat._actionMustNot[a.toString()]&&(Pcm2Compat._actionMustNot[a.toString()]=new Array),Pcm2Compat._actionMustNot[a.toString()].push(b)}static addMustRelation(a,b){void 0==Pcm2Compat._actionMust[a.toString()]&&(Pcm2Compat._actionMust[a.toString()]=new Array),Pcm2Compat._actionMust[a.toString()].push(b)}static addNumActionsFromRelation(a,b,c){void 0==Pcm2Compat._actionNumActionsFrom[a.toString()]&&(Pcm2Compat._actionNumActionsFrom[a.toString()]=new Array),Pcm2Compat._actionNumActionsFrom[a.toString()].push({num:c,since:b})}static addNumActionsRelation(a,b){Pcm2Compat._actionNumActions[a.toString()]=b}static getCurrentAction(){return Pcm2Compat._currentAction}static addRepeat(a,b){void 0==Pcm2Compat._actionRepeat[a.toString()]&&(Pcm2Compat._actionRepeat[a.toString()]=1),Pcm2Compat._actionRepeat[a.toString()]=Pcm2Compat._actionRepeat[a.toString()]+b}static setRepeat(a,b){Pcm2Compat._actionRepeat[a.toString()]=b}static delRepeat(a,b){void 0==Pcm2Compat._actionRepeat[a.toString()]&&(Pcm2Compat._actionRepeat[a.toString()]=1),Pcm2Compat._actionRepeat[a.toString()]=Pcm2Compat._actionRepeat[a.toString()]-b}static isSetAction(a){return void 0==Pcm2Compat._actionRepeat[a.toString()]&&(Pcm2Compat._actionRepeat[a.toString()]=1),void 0==Pcm2Compat._actionSet[a.toString()]&&(Pcm2Compat._actionSet[a.toString()]=0),Pcm2Compat._actionSet[a.toString()]>=Pcm2Compat._actionRepeat[a.toString()]}}Pcm2Compat._actionSet=new Array,Pcm2Compat._actionRunCounter=0,Pcm2Compat._actionFirstRun=new Array,Pcm2Compat._actionLastRun=new Array,Pcm2Compat._actionRepeat=new Array,Pcm2Compat._actionNumActions=new Array,Pcm2Compat._actionMustNot=new Array,Pcm2Compat._actionMust=new Array,Pcm2Compat._actionNumActionsFrom=new Array;class Command extends Control{initialize(a,b){this.bounds=b}setBounds(a){this.bounds=a,this.x=a.x,this.y=a.y,this.width=a.width,this.height=a.height}setViewer(a){this.viewer=a}}class InvisibleCommand extends Command{render(a){}}class Dummy extends InvisibleCommand{}class SetCommand extends InvisibleCommand{initialize(a,b){for(var c=0;a["action"+c]instanceof ActionString;c++)Pcm2Compat.setAction(a["action"+c])}}class UnsetCommand extends InvisibleCommand{initialize(a,b){for(var c=0;a["action"+c]instanceof ActionString;c++)Pcm2Compat.unsetAction(a["action"+c])}}class Goto extends InvisibleCommand{initialize(a,b){this.viewer.runAction(a.target)}}class Must extends InvisibleCommand{initialize(a,b){for(var c=0;a["action"+c]instanceof ActionString;c++)Pcm2Compat.addMustRelation(a.self,a["action"+c])}}class MustNot extends InvisibleCommand{initialize(a,b){for(var c=0;a["action"+c]instanceof ActionString;c++)Pcm2Compat.addMustNotRelation(a.self,a["action"+c])}}class NumActions extends InvisibleCommand{initialize(a,b){Pcm2Compat.addNumActionsRelation(a.self,a.count)}}class NumActionsFrom extends InvisibleCommand{initialize(a,b){Pcm2Compat.addNumActionsFromRelation(a.self,a.since,a.count)}}class RandomCommand extends InvisibleCommand{initialize(a,b){this._result=Math.floor(Math.random()*(a.max-a.min))+a.min,console.log("Random number between "+a.min+" and "+a.max+": "+this._result)}getResult(){return this._result}}class Repeat extends InvisibleCommand{initialize(a,b){void 0!=a.max?this._total=Math.floor(Math.random()*(a.max-a.count))+a.count:this._total=a.count,this._targetAction=a.target}getAction(){var a=Pcm2Compat.getCurrentAction(),b=a.toString();return void 0==Repeat._repeats[b]&&(Repeat._repeats[b]=0),Repeat._repeats[b]<this._total?(Repeat._repeats[b]=Repeat._repeats[b]+1,console.log("Repeating action ("+Repeat._repeats[b]+"/"+this._total+")..."),a):(Repeat._repeats[b]=0,this.viewer.resolveAction(this._targetAction.toString()))}}Repeat._repeats=new Array;class RangeCommand extends InvisibleCommand{initialize(a,b){var c=null;this._validActions=new Array;for(var d=void 0!=a.prefix?a.prefix:"",e=a.from;e<=a.to;e++)c=new ActionString(d+e.toString()),this.viewer.isValidAction(c.toString())&&Pcm2Compat.checkRelations(c)&&this._validActions.push(c)}getAction(){if(null==this._validActions||0==this._validActions.length)return console.error("Range failed: All actions set!"),null;var a=Math.floor(Math.random()*this._validActions.length);return this._validActions[a]}}class RepeatAdd extends InvisibleCommand{initialize(a,b){Pcm2Compat.addRepeat(a.target,a.count)}}class RepeatDel extends InvisibleCommand{initialize(a,b){Pcm2Compat.delRepeat(a.target,a.count)}}class RepeatSet extends InvisibleCommand{initialize(a,b){Pcm2Compat.setRepeat(a.target,a.count)}}class Delay extends Command{constructor(){super(...arguments),this.CLOCKTEMPLATE=`<div>
  <style>
    .wrapper {
      background:#E89E9E;
      width:$SIZE$px;
      height:$SIZE$px;
      position:relative;
      margin:4px auto;    
      border:1px solid #B85959;
      border-radius:50%;
    }  
    
    .pie {
      width:50%;
      height:100%;
      position:absolute;
      background-color:#B85959;
      transform-origin: 100% 50%;
      border:0px solid rgba(0,0,0,0.4);
    }
    
    .spinner {
      border-radius:100% 0 0 100% / 50% 0 0 50%;
      z-index:200;
      border-right:none;            
      animation: rota $SECONDS$s linear 1;
      animation-fill-mode:forwards;
    }
    
    .filler {
      border-radius:0 100% 100% 0 / 0 50% 50% 0;
      z-index:100;
      border-left:none;
      animation:mask $SECONDS$s steps(1,end) 1 reverse;
      animation-fill-mode:forwards;
      left:50%;
      opacity:0;
    }
    
    .mask {
      width:50%;
      height:100%;
      position:absolute;
      z-index:300;      
      opacity:1;
      background:inherit;
      border-radius:100% 0 0 100% / 50% 0 0 50%;
      animation:mask $SECONDS$s steps(1,end) 1;
      animation-fill-mode:forwards;
    }
    
    @keyframes rota {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg);}
    }
    
    @keyframes mask {
      0%        { opacity: 1; }
      50%, 100% { opacity: 0; }
    }
    
    .pietext {
      position:relative;      
      z-index:500;
      height:100%;
    }
    
    .pietext p {      
      position:absolute;
      top:60%;
      transform:translate(-50%,-50%);
      margin:0;
      left:50%;
      color:white;
      font-weight:bold;
    }
  </style>
  <div class="wrapper">
    <div class="pie spinner"></div>
    <div class="pie filler"></div>
    <div class="mask"></div>    
    <div class="pietext"><p></p></div>
  </div>
</div>`,this.UNKNOWNTEMPLATE=`<div>
  <style>
    .wrapper {
      background:#E89E9E;
      width:$SIZE$px;
      height:$SIZE$px;
      position:relative;
      margin:4px auto;    
      border:1px solid #B85959;
      border-radius:50%;
    }  
    
    .pie {
      width:50%;
      height:100%;
      position:absolute;
      background-color:#B85959;
      transform-origin: 100% 50%;
    }
    
    .spinner {
      border-radius:100% 0 0 100% / 50% 0 0 50%;
      z-index:200;
      border-right:none;           
      transform:rotate(35deg);     
    }
    
    .filler {
      border-radius:0 100% 100% 0 / 0 50% 50% 0;
      z-index:100;
      border-left:none;
      left:50%;
      opacity:0;
    }
    
    .mask {
      width:50%;
      height:100%;
      position:absolute;
      z-index:300;      
      opacity:1;
      background:inherit;
      border-radius:100% 0 0 100% / 50% 0 0 50%;
    }
        
    .pietext {
      position:relative;      
      z-index:500;
      height:100%;
    }
    
    .pietext p {      
      position:absolute;
      top:50%;
      transform:translate(-50%,-50%);
      margin:0;
      left:50%;
      color:white;
      font-weight:bold;
      font-size:90px;
      font-family:serif;
    }
    
    .fgpie {
      background-color:white;
      z-index:450;
      position:absolute;
      width:100%;
      height:100%;
      border-radius:50%;
      opacity:0;
      animation:mask 500ms ease infinite ; 
      animation-direction: alternate;
    }
    
    @keyframes mask {
      0%        { opacity: 0.5; }
      50%, 100% { opacity: 0; }
    }
  </style>
  <div class="wrapper">
    <div class="pie spinner"></div>
    <div class="pie filler"></div>
    <div class="mask"></div>    
    <div class="fgpie"></div>  
    <div class="pietext"><p>?</p></div>
  </div>
</div>`}initialize(a,b){if(super.initialize(a,b),a.time instanceof CommandString){var c=a.time.loadCmdClip(this.viewer);a.time=c.getResult()}Settings.get("DEBUG",!1)&&(a.style="normal",a.time=2);var d=(new Date).getTime(),e=1e3*a.time,f=d+e;if("secret"==a.style){var g=Math.min(b.width,b.height,100),h=$(this.UNKNOWNTEMPLATE.split("$SIZE$").join(g.toString()));this.node.append(h)}else if("hidden"==a.style)console.log("Hidden delay: "+a.time+" seconds");else{var g=Math.min(b.width,b.height,100),h=$(this.CLOCKTEMPLATE.split("$SECONDS$").join(a.time).split("$SIZE$").join(g.toString()));this._remainingTime=h.find(".pietext>p"),this.node.append(h)}this._timer=window.setInterval(()=>{var b=NaN,c=NaN;if(this._destroyed)return void window.clearInterval(this._timer);var d=f-(new Date).getTime(),g=Math.min(Math.ceil(400*(1-d/e)),400);"secret"!=a.style&&"hidden"!=a.style&&(b=Math.ceil(d/1e3),b>60?(c=Math.floor(b/60),b%=60,b<10?this._remainingTime.text(c+":0"+b):this._remainingTime.text(c+":"+b)):this._remainingTime.text(b.toString())),400==g&&(window.clearInterval(this._timer),this.viewer.runAction(a.target))},100),this.setBounds(b)}destroy(){this._destroyed=!0,super.destroy()}}class TextView extends Command{initialize(a,b){super.initialize(a,b),this._textField=$("<p></p>");var c=$(a.text);c.find("font").attr("size",(a,b)=>{return Number(b)/5}),c.find("font").attr("face","");c.each(function(){$(this).html($(this).html().replace(/(https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*))/gi,'<a href="$1" target="_blank">$1</a>'))}),this._textField.html($("<div>").append(c).html()),this.node.append(this._textField),this.setBounds(b)}}class Pic extends Command{initialize(a,b){super.initialize(a,b),void 0==a.id&&(a.id="");var c=MediaLoader.showImage(a.id,a=>this.createImage(a,0,0));null!=c&&this.createImage(c.url,c.width,c.height)}createImage(a,b,c){this._img=$("<img />"),this._img.css("position","absolute"),0!=b||0!=c?(this._imgwidth=b,this._imgheight=c,this.setBounds(this.bounds)):(console.log("image was not preloaded"),this._img.load(()=>{this._imgwidth=this._img.width(),this._imgheight=this._img.height(),this.setBounds(this.bounds)})),this._img.attr("src",a),this.node.append(this._img)}setBounds(a){if(super.setBounds(a),null!=this._img){let b=Math.min(a.width/this._imgwidth,a.height/this._imgheight);this._img.width(this._imgwidth*b),this._img.height(this._imgheight*b),this._img.css("left",(a.width-this._img.width())/2+a.x),this._img.css("top",(a.height-this._img.height())/2+a.y)}}}class SoundCommand extends InvisibleCommand{initialize(a,b){void 0==a.id&&(a.id=""),void 0==a.loops&&(a.loops=1);var c=MediaLoader.getSound(a.id,a=>this.createElement(a));null!=c&&(this._sound=c.audio,this._sound.play(),this.node.append(this._sound))}createElement(a){this._sound=new Audio(a),this._sound.play(),this.node.append(this._sound)}destroy(){this._sound&&!this._sound.paused&&this._sound.pause()}}class Mult extends Command{constructor(){super(...arguments),this._elements=new Array}initialize(a,b){super.initialize(a,b);for(var c=0;a["e"+c]instanceof CommandString;c++)this._elements[c]=a["e"+c].loadCmdClip(this.viewer,b),this.addChild(this._elements[c]);this.setBounds(b)}destroy(){for(var a in this._elements)this._elements[a].destroy();super.destroy()}setBounds(a){super.setBounds(a);var b=a;b.x=0,b.y=0;for(var c in this._elements)this._elements[c].setBounds(b)}}class Button extends Control{constructor(a){super(),this.node=$("<button>"+a+"</button>"),this.node.css("position","absolute")}addClickHandler(a){this.node.click(b=>a(this))}}class Go extends Command{initialize(a,b){super.initialize(a,b),this._button=new Button("Continue"),this._button.addClickHandler(b=>{this.viewer.runAction(a.target)}),this.addChild(this._button),this.setBounds(this.bounds)}setBounds(a){var b=a.width-20;super.setBounds(a),this._button.y=10,this._button.width=b,this._button.height=25,this._button.x=a.width/2-this._button.width/2}}class Yn extends Command{initialize(a,b){super.initialize(a,b),this._yesButton=new Button("YES"),this._yesButton.addClickHandler(b=>{this.viewer.runAction(a.yes.toString())}),this.addChild(this._yesButton),this._noButton=new Button("NO"),this._noButton.addClickHandler(b=>{this.viewer.runAction(a.no.toString())}),this.addChild(this._noButton),this.setBounds(this.bounds)}setBounds(a){var b=a.width-20;super.setBounds(a),this._yesButton.y=10,this._yesButton.width=b,this._yesButton.height=25,this._yesButton.x=a.width/2-this._yesButton.width/2,this._noButton.y=45,this._noButton.width=b,this._noButton.height=25,this._noButton.x=a.width/2-this._noButton.width/2}}class Horiz extends Command{constructor(){super(...arguments),this._elements=new Array}initialize(a,b){super.initialize(a,b);for(var c=0;a["e"+c]instanceof CommandString;c++)this._elements[c]=a["e"+c].loadCmdClip(this.viewer,this.calculateElementBounds(b,c)),this.addChild(this._elements[c]);this.setBounds(b)}setBounds(a){super.setBounds(a);for(var b in this._elements)this._elements[b].setBounds(this.calculateElementBounds(a,Number(b)))}destroy(){for(var a in this._elements)this._elements[a].destroy()}calculateElementBounds(a,b){var c=a.width/this._elements.length;return{x:c*b,y:0,width:c,height:a.height}}}class Vert extends Horiz{calculateElementBounds(a,b){var c=a.height/this._elements.length;return{x:0,y:c*b,width:a.width,height:c}}}class Buttons extends Command{constructor(){super(...arguments),this._buttonCaps=new Array,this._buttons=new Array}initialize(a,b){super.initialize(a,b);for(var c=null,d=0;null!=a["target"+d];d++)c=a["cap"+d]?a["cap"+d]:d.toString(),this.addButton(d,a["target"+d],c);this.setBounds(b)}addButton(a,b,c){this._buttons[a]=new Button(c),this._buttons[a].addClickHandler(a=>{this.viewer.runAction(b.toString())}),this.addChild(this._buttons[a])}calculateButtonBounds(a,b){var c=a.width-20;return{x:a.width/2-c/2,y:35*b,width:c,height:25}}setBounds(a){super.setBounds(a);for(var b in this._buttons){var c=this.calculateButtonBounds(a,Number(b));this._buttons[b].x=c.x,this._buttons[b].y=c.y,this._buttons[b].width=c.width,this._buttons[b].height=c.height}}}class SplitView extends Command{constructor(){super(),this.node.addClass("splitView")}}class Page extends Command{initialize(a,b){if(super.initialize(a,b),(a.instruc instanceof CommandString||a.action instanceof CommandString)&&(this._splitView=new SplitView,this.addChild(this._splitView),this.positionSidebar(b)),a.text instanceof CommandString)this._textClip=a.text.loadCmdClip(this.viewer,"text",this.calculateTextBounds(b)),this.addChild(this._textClip);else if("String"==a.text.constructor.name){var c=new CommandString("text(text:'"+a.text.split("'").join("\\'")+"')");this._textClip=c.loadCmdClip(this.viewer,this.calculateTextBounds(b)),this.addChild(this._textClip)}if(a.media instanceof CommandString&&(this._mediaClip=a.media.loadCmdClip(this.viewer,this.calculateMediaBounds(b)),this.addChild(this._mediaClip)),a.instruc instanceof CommandString&&(this._instrucClip=a.instruc.loadCmdClip(this.viewer,this.calculateInstrucBounds(b)),this.addChild(this._instrucClip)),a.action instanceof CommandString&&(this._actionClip=a.action.loadCmdClip(this.viewer,this.calculateActionBounds(b)),this.addChild(this._actionClip)),a.hidden instanceof CommandString&&(this._hiddenClip=a.hidden.loadCmdClip(this.viewer,{})),this.setBounds(b),null==this._splitView&&null==this._actionClip&&null==this._hiddenClip){this._splitView=new SplitView,this.addChild(this._splitView),this.positionSidebar(b);var d=new CommandString("buttons(target0:'exittease',cap0:'Exit Tease')");this._actionClip=d.loadCmdClip(this.viewer,this.calculateActionBounds(b)),this.addChild(this._actionClip)}}setBounds(a){null!=this._splitView&&this.positionSidebar(a),null!=this._textClip&&this._textClip.setBounds(this.calculateTextBounds(a)),null!=this._mediaClip&&this._mediaClip.setBounds(this.calculateMediaBounds(a)),null!=this._instrucClip&&this._instrucClip.setBounds(this.calculateInstrucBounds(a)),null!=this._actionClip&&this._actionClip.setBounds(this.calculateActionBounds(a)),super.setBounds(a)}destroy(){null!=this._hiddenClip&&(this._hiddenClip.destroy(),this._hiddenClip=null),super.destroy()}calculateTextBounds(a){var b=null!=this._splitView?Number(a.width-150):Number(a.width);return{x:a.x,y:a.y+.7*a.height,width:b,height:.3*a.height}}calculateInstrucBounds(a){return{x:a.x+a.width-150,y:a.y,width:150,height:.5*a.height}}calculateMediaBounds(a){var b=null!=this._splitView?Number(a.width-150):Number(a.width);return{x:a.x,y:a.y,width:b,height:.7*a.height}}calculateActionBounds(a){return{x:a.x+a.width-150,y:a.y+.5*a.height,width:150,height:.5*a.height}}positionSidebar(a){this._splitView.x=a.x+a.width-150,this._splitView.y=a.y,this._splitView.width=150,this._splitView.height=a.height}}class Parser{static explode(a,b){var c=NaN,d=null,e=new Array;if(null==a)return[];if(null==b)return[];for(var f=0;f<b.length&&(c=b.indexOf(a,f))!=-1;)d=b.slice(f,c),e.push(d),f=c+1;return e.length<1?e.push(b):e.push(b.slice(f,b.length)),e}static explodeWithParenthesis(a,b){var c=null;if(null==b)return[];for(var d=new Array,e="",f="",g=0,h=0,i=0,j=0;j<b.length;j++){switch(e=b.charAt(j),g){case 0:"'"==e?g=1:'"'==e?g=2:"("==e?h++:")"==e?h--:e==a&&0==h&&(c=b.slice(i,j),d.push(c),i=j+1);break;case 1:"'"==e&&"\\"!=f&&(g=0);break;case 2:'"'==e&&"\\"!=f&&(g=0)}f=e}return d.length<1?d.push(b):d.push(b.slice(i,b.length)),d}static parseParameter(a){return"'"==a.substr(0,1)||'"'==a.substr(0,1)?Parser.parseString(a):"#"==a.substr(-1)?new ActionString(a.substr(0,a.length-1)):"hrs"==a.substr(-3)||"min"==a.substr(-3)||"sec"==a.substr(-3)?Parser.parseTime(a):isNaN(parseInt(a))?a.indexOf("(")&&")"==a.substr(-1)?new CommandString(a):a:parseInt(a)}static parseParamList(a){var b=null,c=null,d=NaN,e=null,f=null,g=Parser.explodeWithParenthesis(",",a),h=new Array;for(b in g)c=g[b],d=c.indexOf(":"),e=c.substr(0,d),f=c.substr(d+1),h[e]=Parser.parseParameter(f);return h}static parseString(a){return a=a.substr(1,a.length-2),a=a.split("\\'").join("'")}static parseTime(a){var b=a.substr(-3),c=parseInt(a.substr(0,a.length-3));return"hrs"==b?3600*c:"min"==b?60*c:c}}class Rating{constructor(a){this._target=a,this.render(),this._target.hide()}show(){this._target.show(1)}render(){var a=$("<div></div>");a.append("<p>Please rate this tease.</p>");for(var b=this,c=1;c<=5;c++){var d=$(`<img src="images/ustar.png" data-id="${c}" title="${c} Star${c>1?"s":""}" />`);d.mouseenter(function(c){b.highlight(a,Number($(c.target).attr("data-id")),!0)}),d.mouseout(function(c){b.highlight(a,Number($(c.target).attr("data-id")),!1)}),d.click(function(a){b.submit(Number($(a.target).attr("data-id")))}),a.append(d)}a.append('<p><a href="/">Go Back.</a></p>'),this._target.append(a)}highlight(a,b,c){for(var d=a.find("img"),e=0;e<b;e++)$(d[e]).attr("src",c?"images/star.png":"images/ustar.png")}submit(a){$.ajax({url:`vote?id=${Settings.get("teaseId")}&vote=${a}`,type:"GET",success:function(a){location.href="/"}})}}$().ready(()=>runTease(Number(getQueryVariable("id")),Number(getQueryVariable("resume"))));